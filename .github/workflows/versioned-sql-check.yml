#!/bin/bash
set -e

MIGRATION_DIR="src/main/resources/database/migration_flyway"
REVERT_DIR="src/main/resources/database/revert_flyway"
TARGET_DIRS=("$MIGRATION_DIR" "$REVERT_DIR")

echo "üîç Comparing origin/main...HEAD"
git fetch origin main

# Find changed SQL files in both directories
CHANGED_FILES=$(git diff --name-only origin/main...HEAD -- "${TARGET_DIRS[@]}" | grep -E 'V[0-9]+\.[0-9]+_migration.*\.sql$' || true)

if [[ -z "$CHANGED_FILES" ]]; then
  echo "‚úÖ No SQL migration files changed."
  exit 0
fi

echo "üìù Changed files:"
echo "$CHANGED_FILES"

# Group all files by version (across all dirs)
declare -A VERSION_GROUPS

for file in $CHANGED_FILES; do
  filename=$(basename "$file")
  version=$(echo "$filename" | grep -oE '^V[0-9]+\.[0-9]+')

  echo "‚û°Ô∏è  Processing file: $filename (version: $version)"
  VERSION_GROUPS["$version"]="${VERSION_GROUPS["$version"]} $file"
done

# Process eac
